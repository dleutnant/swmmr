<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>How to autocalibrate a SWMM model with swmmr • swmmr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="How to autocalibrate a SWMM model with swmmr">
<meta property="og:description" content="swmmr">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">swmmr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.9.1.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/How_swmmr_reads_and_writes_files.html">How swmmr reads and writes SWMM files</a>
    </li>
    <li>
      <a href="../articles/How_to_autocalibrate_a_SWMM_model_with_swmmr.html">How to autocalibrate a SWMM model with swmmr</a>
    </li>
    <li>
      <a href="../articles/How_to_convert_between_GIS_data_and_SWMM_with_swmmr.html">Conversion between GIS data and SWMM with swmmr</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/dleutnant/swmmr/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>How to autocalibrate a SWMM model with
swmmr</h1>
                        <h4 data-toc-skip class="author">Dominik
Leutnant</h4>
            
            <h4 data-toc-skip class="date">2023-01-19</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/dleutnant/swmmr/blob/HEAD/vignettes/How_to_autocalibrate_a_SWMM_model_with_swmmr.Rmd" class="external-link"><code>vignettes/How_to_autocalibrate_a_SWMM_model_with_swmmr.Rmd</code></a></small>
      <div class="hidden name"><code>How_to_autocalibrate_a_SWMM_model_with_swmmr.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>Model calibration or optimization is an essential part within the
modelling chain to improve the model quality. During calibration, model
parameter values are systematically modified to optimize an objective
function, which numerically expresses the difference between observation
and simulation data. In this tutorial, we walk through the required
steps to autocalibrate a SWMM model with <code>swmmr</code>. We
calibrate the <em>Example1.inp</em> model which is shipped with the
offical SWMM executable from US EPA. For the optimization, we use the
<code>DEoptim</code> package, which provides a differential evolution
optimization algorithm.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/dleutnant/swmmr" class="external-link">swmmr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ArdiaD/DEoptim" class="external-link">DEoptim</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h2>
<p>First, model paths are defined and a simulation run is initiated with
<code>run_swmm</code> to check for errors.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># set path to inp</span></span>
<span><span class="co"># If your operating system is Windows, the Example1.inp model is usually </span></span>
<span><span class="co"># located at "C:\Users\your user name\Documents\EPA SWMM Projects\Examples".</span></span>
<span><span class="co"># For convenience the Example1.inp model is also included in the swmmr package.</span></span>
<span><span class="co"># Feel free to change this to your path of choice.</span></span>
<span><span class="va">inp_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"Example1.inp"</span>, package <span class="op">=</span> <span class="st">"swmmr"</span>, mustWork <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># both rpt and out files are temporary files</span></span>
<span><span class="va">tmp_rpt_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">tmp_out_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># initiate the simulation</span></span>
<span><span class="va">swmm_files</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_swmm.html">run_swmm</a></span><span class="op">(</span></span>
<span>  inp <span class="op">=</span> <span class="va">inp_file</span>,</span>
<span>  rpt <span class="op">=</span> <span class="va">tmp_rpt_file</span>,</span>
<span>  out <span class="op">=</span> <span class="va">tmp_out_file</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The original output of the first simulation run is assumed to be the
observation data. The parameter of interest is <code>total_runoff</code>
at node <code>18</code>. We load the observation data as an
<code>xts</code> object with <code>read_out</code>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">obs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_out.html">read_out</a></span><span class="op">(</span></span>
<span>  file <span class="op">=</span> <span class="va">swmm_files</span><span class="op">$</span><span class="va">out</span>,</span>
<span>  iType <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  object_name <span class="op">=</span> <span class="st">"18"</span>,</span>
<span>  vIndex <span class="op">=</span> <span class="fl">4</span></span>
<span><span class="op">)</span><span class="op">[[</span><span class="st">"18"</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">total_inflow</span></span></code></pre></div>
<p>To keep it simple, we only calibrate the model parameter
<code>Perc_Imperv</code> of subcatchments which are larger than 10 ha.
The original parameter values are “50” for subcatchment “5” and “10” for
subcatchment “6”. The model structure is loaded with
<code>read_inp</code>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># read model structure</span></span>
<span><span class="va">inp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_inp.html">read_inp</a></span><span class="op">(</span><span class="va">swmm_files</span><span class="op">$</span><span class="va">inp</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># show the original parameter values</span></span>
<span><span class="va">inp</span><span class="op">$</span><span class="va">subcatchments</span><span class="op">[</span><span class="va">inp</span><span class="op">$</span><span class="va">subcatchments</span><span class="op">$</span><span class="va">Area</span> <span class="op">&gt;</span> <span class="fl">10</span>, <span class="op">]</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="goodness-of-fit-criteria">Goodness-of-fit criteria<a class="anchor" aria-label="anchor" href="#goodness-of-fit-criteria"></a>
</h2>
<p>To numerically evaluate the difference between observation and
simulation data, we use the Nash-Sutcliffe efficiency (nse).</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># function calculates the goodness of fit value</span></span>
<span><span class="co"># input x is a two column xts object, col1: obs, col2: sim</span></span>
<span><span class="va">nse</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">x</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="va">x</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">^</span> <span class="fl">2</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">x</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">^</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="objective-function">Objective function<a class="anchor" aria-label="anchor" href="#objective-function"></a>
</h2>
<p>The optimization algorithm exactly needs one function to be
minimized. Therefore, we define a function that</p>
<ol style="list-style-type: decimal">
<li>first argument takes a vector of real-valued parameters,</li>
<li>second argument is a loaded <code>inp</code> file, containing a list
of SWWM section as tibbles and</li>
<li>takes observation data as a third argument.</li>
</ol>
<p>The function mainly consists of three sections. First, a new
parameter set generated from the optimization algorithm overrides the
original values of the <code>inp</code> object. The updated
<code>inp</code> object is then written to disk with
<code>write_inp</code>. Second a simulation run is performed with the
new <code>inp</code> file and results are read with
<code>read_out</code>. Finally, the goodness-of-fit value is
calculated.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">obj_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">inp</span>, <span class="va">obs</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>  <span class="co"># set new parameters and update inp object</span></span>
<span>  <span class="va">inp</span><span class="op">$</span><span class="va">subcatchments</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/transform.html" class="external-link">transform</a></span><span class="op">(</span></span>
<span>    <span class="va">inp</span><span class="op">$</span><span class="va">subcatchments</span>,</span>
<span>    Perc_Imperv <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">Area</span> <span class="op">&gt;</span> <span class="fl">10</span>, <span class="va">x</span>, <span class="va">Perc_Imperv</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># write new inp file to disk</span></span>
<span>  <span class="va">tmp_inp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/write_inp.html">write_inp</a></span><span class="op">(</span><span class="va">inp</span>, <span class="va">tmp_inp</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># run swmm with new parameter set</span></span>
<span>  <span class="va">swmm_files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressMessages</a></span><span class="op">(</span><span class="fu"><a href="../reference/run_swmm.html">run_swmm</a></span><span class="op">(</span><span class="va">tmp_inp</span>, stdout <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># remove files when function exits to avoid heavy disk usage</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.remove</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">swmm_files</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># read sim result</span></span>
<span>  <span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_out.html">read_out</a></span><span class="op">(</span></span>
<span>    file <span class="op">=</span> <span class="va">swmm_files</span><span class="op">$</span><span class="va">out</span>, <span class="co"># path to out file</span></span>
<span>    iType <span class="op">=</span> <span class="fl">1</span>, <span class="co"># type: node</span></span>
<span>    object_name <span class="op">=</span> <span class="st">"18"</span>, <span class="co"># name of node</span></span>
<span>    vIndex <span class="op">=</span> <span class="fl">4</span> <span class="co"># parameter at node: total inflow</span></span>
<span>  <span class="op">)</span><span class="op">[[</span><span class="st">"18"</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">total_inflow</span> <span class="co"># directly access to xts object</span></span>
<span></span>
<span>  <span class="co"># calculate goodness-of-fit</span></span>
<span>  <span class="co"># note: multiply by minus one to have a real min problem (nse: +1 to -Inf)</span></span>
<span>  <span class="fu">nse</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">obs</span>, <span class="va">sim</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="op">-</span><span class="fl">1</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="optimization">Optimization<a class="anchor" aria-label="anchor" href="#optimization"></a>
</h2>
<p>Finally, we need to config the optimization algorithm. It is required
to provide</p>
<ol style="list-style-type: decimal">
<li>the function to be optimized</li>
<li>parameter bounds (lower, upper)</li>
<li>a list of control parameters (useful for parallel computing or fine
tuning)</li>
<li>further argument passed to the function to be minimized (here: the
<code>ìnp</code> object and the observation data)</li>
</ol>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">84</span><span class="op">)</span> <span class="co"># to get reproducible results</span></span>
<span></span>
<span>  <span class="va">calibration_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/DEoptim/man/DEoptim.html" class="external-link">DEoptim</a></span><span class="op">(</span></span>
<span>    fn <span class="op">=</span> <span class="va">obj_fun</span>, </span>
<span>    lower <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>, </span>
<span>    upper <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">100</span><span class="op">)</span>,</span>
<span>    control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      itermax <span class="op">=</span> <span class="fl">50</span>, <span class="co"># maximum iterations</span></span>
<span>      trace <span class="op">=</span> <span class="fl">10</span>, <span class="co"># print progress every 10th iteration</span></span>
<span>      packages <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"swmmr"</span><span class="op">)</span>, <span class="co"># export packages to optimization environment</span></span>
<span>      parVar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"nse"</span><span class="op">)</span>, <span class="co"># export function to optimization environment</span></span>
<span>      parallelType <span class="op">=</span> <span class="fl">0</span> <span class="co"># set to 1 to use all available cores</span></span>
<span>    <span class="op">)</span>,</span>
<span>    inp <span class="op">=</span> <span class="va">inp</span>, <span class="co"># 'inp' object</span></span>
<span>    obs <span class="op">=</span> <span class="va">obs</span> <span class="co"># xts object containing observation data</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">calibration_res</span><span class="op">)</span></span></code></pre></div>
<p>The calibration yields as optimized parameter values which is close
to the original values.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Dominik Leutnant, Anneke Doering.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
